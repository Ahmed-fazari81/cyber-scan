import express from "express";
import cors from "cors";
import fetch from "node-fetch";

const app = express();

// ØªÙØ¹ÙŠÙ„ CORS Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
app.use(cors());

// Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)
app.use(express.json({ limit: "50mb" }));

// Ù†Ù‚Ø·Ø© ÙØ­Øµ Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„
app.get("/", (req, res) => {
  res.send("CyberShield AI Engine is Running - Version 2026 ðŸ›¡ï¸");
});

// Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
app.post("/analyze", async (req, res) => {
  try {
    const { input, type, apiKey } = req.body;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if (!input || !apiKey) {
      return res.status(400).json({ error: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© (Ù…ÙØªØ§Ø­ API Ø£Ùˆ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©)" });
    }

    // --- Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± (The Brain of the App) ---
    // Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡ÙŠ Ø§Ù„ØªÙŠ ØªØ¬Ø¹Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø°ÙƒÙŠØ§Ù‹ ÙÙŠ ÙƒØ´Ù Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ ÙˆØ§Ù„ØªØ²ÙŠÙŠÙ
    const systemPrompt = `
    Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ ÙˆÙ…Ø­Ù‚Ù‚ ÙÙŠ Ø§Ù„Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (Digital Forensics Expert).
    Ù…Ù‡Ù…ØªÙƒ: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ø¹Ù…Ù‚ Ù„ÙƒØ´Ù "Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©"ØŒ "Ø§Ù„ØªØ²ÙŠÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ‚"ØŒ Ùˆ"Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ÙŠØ©".

    Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„ (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù†ØµØ§Ù‹ØŒ Ø±Ø§Ø¨Ø·Ø§Ù‹ØŒ Ø£Ùˆ ØµÙˆØ±Ø©) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØ§Ù„ÙŠØ©:
    1. **Ø§Ù„Ù…ØµØ¯Ø± (Source Identification):** Ø­Ø§ÙˆÙ„ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØªÙŠ ÙŠÙ†ØªÙ…ÙŠ Ø¥Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù…Ø«Ù„Ø§Ù‹: Wikipedia, Instagram, WhatsApp, Corporate HR, Unknown).
    2. **Ø§Ù„ØªØµÙŠØ¯ (Phishing):** Ù‡Ù„ Ø§Ù„Ù†Øµ ÙŠØ·Ù„Ø¨ "Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ø¬Ù„" ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ù„ ÙŠØ¯Ø¹ÙŠ Ø£Ù†Ù‡ Ù…Ù† Ø´Ø±ÙƒØ© Ù…Ø¹Ø±ÙˆÙØ© Ù„ÙƒÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ØºØ±ÙŠØ¨ØŸ
    3. **Ø§Ù„ØªØ²ÙŠÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ‚ (Deepfake - Ù„Ù„ØµÙˆØ±):** Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ´ÙˆÙ‡Ø§Øª ÙÙŠ Ø§Ù„Ø£ÙŠØ¯ÙŠØŒ Ø§Ù„Ø¹ÙŠÙˆÙ†ØŒ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ØºÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©.
    4. **Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªÙ‚Ù†ÙŠ:** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http (Ø¨Ø¯ÙˆÙ† s) ÙÙ‡Ùˆ "Suspicious" ÙÙˆØ±Ø§Ù‹.

    Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
    ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø¯ Ø¨ØµÙŠØºØ© JSON *ÙÙ‚Ø·* (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†ØµÙˆØµ Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ùˆ Markdown) ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:
    {
      "status": "safe" | "suspicious" | "dangerous",
      "risk_score": Ø±Ù‚Ù… Ù…Ù† 0 Ø¥Ù„Ù‰ 100 (Ø­ÙŠØ« 100 Ù‡Ùˆ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø·ÙˆØ±Ø©),
      "source": "Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙƒØªØ´Ù (Ù…Ø«Ù„Ø§Ù‹: Instagram, Wikipedia, Unknown)",
      "content_type": "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Phishing Link, Deepfake Image, Safe Website, Scam Text)",
      "summary": "Ù…Ù„Ø®Øµ Ø¯Ù‚ÙŠÙ‚ ÙŠØ´Ø±Ø­ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¢Ù…Ù† Ø£Ùˆ Ø®Ø·ÙŠØ±",
      "technical_details": "Ø´Ø±Ø­ ØªÙ‚Ù†ÙŠ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù†Ø·Ø§Ù‚ Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ©ØŒ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ù†ØªÙ‡ÙŠØ©ØŒ ÙˆØ¬ÙˆØ¯ ØªØ´ÙˆÙ‡Ø§Øª Ø¨ØµØ±ÙŠØ© ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©...)",
      "recommendation": "Ù†ØµÙŠØ­Ø© Ø£Ù…Ù†ÙŠØ© ØµØ§Ø±Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"
    }
    `;

    let requestBody;

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ Ù„Ù†Ù…ÙˆØ°Ø¬ Gemini
    if (type === "image") {
        // ØªÙ†Ø¸ÙŠÙ ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© Base64
        const base64Data = input.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/, "");
        
        requestBody = {
            contents: [{
                parts: [
                    { text: systemPrompt + "\n\n [ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø©]: Ù‚Ù… Ø¨ÙØ­Øµ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø© Ù„ÙƒØ´Ù Ø§Ù„ØªØ²ÙŠÙŠÙ Ø£Ùˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„:" },
                    { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                ]
            }]
        };
    } else {
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·
        requestBody = {
            contents: [{
                parts: [{ text: `${systemPrompt}\n\n [ØªØ­Ù„ÙŠÙ„ Ù†Øµ/Ø±Ø§Ø¨Ø·]: ${input}` }]
            }]
        };
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Google Gemini API
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestBody)
      }
    );

    const data = await response.json();
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    let rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

    // --- Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°ÙƒÙŠ (Cleaning & Parsing) ---
    // Ø§Ù„Ù‡Ø¯Ù: Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙˆØ¯ JSON Ø§Ù„ØµØ§ÙÙŠ Ø­ØªÙ‰ Ù„Ùˆ Ø£Ø¶Ø§Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø´Ø±Ø­Ø§Ù‹ Ù†ØµÙŠØ§Ù‹ Ù‚Ø¨Ù„Ù‡ Ø£Ùˆ Ø¨Ø¹Ø¯Ù‡
    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
    
    if (jsonMatch) {
        try {
            const jsonResult = JSON.parse(jsonMatch[0]);
            res.json(jsonResult);
        } catch (e) {
            console.error("JSON Parsing Failed:", e);
            throw new Error("Failed to parse AI response");
        }
    } else {
        // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ø±Ø¯ Ø¨Ù€ JSONØŒ Ù†Ø¹ÙŠØ¯ Ø±Ø¯Ø§Ù‹ "Ù…Ø´Ø¨ÙˆÙ‡" Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙˆÙ‚Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        console.warn("No JSON found in response:", rawText);
        res.json({
            status: "suspicious",
            risk_score: 60,
            source: "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            content_type: "ØªØ­Ù„ÙŠÙ„ ØºÙŠØ± Ù…Ø¤ÙƒØ¯",
            summary: "Ù‚Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆÙ„ÙƒÙ†Ù‡ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¯Ù‚Ø© 100%.",
            technical_details: "Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù… ÙŠÙƒÙ† Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©ØŒ Ù…Ù…Ø§ ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø­Ø°Ø±.",
            recommendation: "ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ù…Ù„Ù Ø­ØªÙ‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØµØ¯Ø± Ø¢Ø®Ø±."
        });
    }

  } catch (err) {
    console.error("Server Error:", err);
    res.status(500).json({ 
        error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„",
        details: err.message 
    });
  }
});

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
const PORT = process.env.PORT || 10000;
app.listen(PORT, () => console.log(`ðŸš€ CyberShield Server Running on Port ${PORT}`));
